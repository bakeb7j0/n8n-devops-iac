# n8n DevOps Automation Project Seed Document

## Objective

To automate the provisioning, deployment, monitoring, and diagnostics of individual user-scoped n8n HTTP services within an AWS Fargate ECS cluster. Each user receives their own dedicated n8n instance accessible via a path on a shared Application Load Balancer (ALB). This is achieved with infrastructure as code and operational scripts.

## Design Overview

* Each user (e.g., `brbaker`) is provisioned with an ECS Fargate service that runs a containerized instance of n8n.
* An Application Load Balancer (ALB) handles routing requests to user-specific path rules (e.g., `/brbaker/*`) which are forwarded to their respective target groups.
* Each deployment includes:

  * An ECS service
  * A target group with health checks
  * An ALB listener rule
* Health and reachability diagnostics are automated.
* All AWS resources are provisioned and deprovisioned safely and idempotently.

## Environment Variables

These variables are sourced from `n8n.env` and used across deployment scripts:

```
REGION=us-east-1
PROFILE=alog-admin
ACCOUNT_ID=381491979781

VPC_ID=vpc-068f245f8e1f5398e
EFS_ID=fs-0d0517af2cbe19317
SG_ID=sg-0acad1bc80131a83f
RT_ID=rtb-0ee3bd6766d4deb48
SUBNET_ID_A=subnet-04eafd78f15a51257
SUBNET_ID_B=subnet-0a378860b19def4cc
IGW_ID=igw-0d62f120f9f1282df

TASK_ROLE_ARN=arn:aws:iam::381491979781:role/n8nEcsTaskRole
EXECUTION_ROLE_ARN=arn:aws:iam::381491979781:role/n8nEcsTaskExecutionRole
CLUSTER_NAME=n8n-dev-cluster
ALB_NAME=n8n-dev-alb
ALB_DNS=n8n-dev-alb-1332110457.us-east-1.elb.amazonaws.com
TG_ARN=arn:aws:elasticloadbalancing:us-east-1:381491979781:targetgroup/tg-brbaker/2b017ba99bab2c2e
```

## Key AWS Resources

* **VPC**: `vpc-068f245f8e1f5398e`
* **Subnets**: `subnet-04eafd78f15a51257`, `subnet-0a378860b19def4cc`
* **Security Group**: `sg-0acad1bc80131a83f`
* **ALB**: `n8n-dev-alb`
* **ALB DNS**: `n8n-dev-alb-1332110457.us-east-1.elb.amazonaws.com`
* **ECS Cluster**: `n8n-dev-cluster`
* **IAM Roles**: `n8nEcsTaskRole`, `n8nEcsTaskExecutionRole`

## Scripts

### `deploy_user_service.sh`

Deploys or updates the ECS Fargate service for a given user:

* Deletes existing listener rule and target group (if possible)
* Waits for ECS service to drain and go inactive
* Re-creates target group, ALB rule, and ECS service
* Appends updated values to `n8n.env`
* Usage: `./deploy_user_service.sh brbaker`

### `asses_n8n_instance.sh`

Checks the state of a user's deployed n8n service:

* ECS service status (desired/running count)
* Target group health status
* Connectivity test using curl
* Provides human-readable diagnostics and fix suggestions
* Usage: `./asses_n8n_instance.sh brbaker`

## Deployment History & Issues

* **DNS resolution errors** resolved by correcting `resolv.conf` and using public nameservers.
* **TargetGroup deletion failures** due to lingering listener rules now resolved via detection and deletion logic.
* **ECS stuck deployments** were resolved by scripting active state checks and waits.
* **Health checks returning 404** prompted change from `/` to `/healthz` in container config.
* **Missing DesiredCount** in ECS service resolved by explicitly setting it to `1`.
* **InvalidParameter and InUse errors** are handled via smart retry logic and AWS CLI filters.

## Outstanding Work

* [ ] Validate health check endpoints for custom user images.
* [ ] Add support for secure HTTPS and custom domain mappings.
* [ ] Build cleanup script for orphaned resources.
* [ ] Improve logging and metrics for automated monitoring.
* [ ] Allow per-user environment variable overrides.
* [ ] Write script to tear down all resources for a user.

## Seed Instructions

To continue development in another environment:

1. Clone this repository and ensure `n8n.env` exists with correct values.
2. Use `deploy_user_service.sh <user>` to create or update an instance.
3. Use `asses_n8n_instance.sh <user>` to verify.
4. All changes should be committed and tracked in Git.
5. Always append new resource ARNs or DNS values to `n8n.env` for consistency.

## Example Deployment

```
./deploy_user_service.sh brbaker
./asses_n8n_instance.sh brbaker
```

---

This document captures the full scope of the n8n deployment effort and is suitable as a seed for any engineer picking up this work.

